@echo off
REM WinSplit Revolution Penetration Testing Tools Setup
REM Downloads and configures security testing tools from GitHub

setlocal enabledelayedexpansion

echo.
echo ============================================================
echo  WinSplit Security Testing Tools Setup
echo ============================================================
echo.

REM Create tools directory
if not exist "tools" mkdir tools
cd tools

REM Check for required tools
where git >nul 2>&1
if errorlevel 1 (
    echo ERROR: git not found. Please install Git for Windows.
    exit /b 1
)

where cmake >nul 2>&1
set HAS_CMAKE=0
if not errorlevel 1 set HAS_CMAKE=1

echo Downloading security testing tools...
echo.

REM ============================================================
REM 1. Dr. Memory - Memory error detector
REM ============================================================
echo [1/6] Dr. Memory (memory leak detector)
if not exist "drmemory" (
    echo   Downloading Dr. Memory...
    powershell -Command "Invoke-WebRequest -Uri 'https://github.com/DynamoRIO/drmemory/releases/download/release_2.6.0/DrMemory-Windows-2.6.0.zip' -OutFile 'drmemory.zip'"
    if exist "drmemory.zip" (
        powershell -Command "Expand-Archive -Path 'drmemory.zip' -DestinationPath '.'"
        ren DrMemory-Windows-2.6.0 drmemory
        del drmemory.zip
        echo   OK: Dr. Memory installed
    ) else (
        echo   WARN: Could not download Dr. Memory
    )
) else (
    echo   Already installed
)

REM ============================================================
REM 2. Process Hacker - Advanced process monitoring
REM ============================================================
echo [2/6] Process Hacker (process analysis)
if not exist "processhacker" (
    echo   Downloading Process Hacker...
    powershell -Command "Invoke-WebRequest -Uri 'https://github.com/processhacker/processhacker/releases/download/v2.39/processhacker-2.39-bin.zip' -OutFile 'ph.zip'"
    if exist "ph.zip" (
        mkdir processhacker
        powershell -Command "Expand-Archive -Path 'ph.zip' -DestinationPath 'processhacker'"
        del ph.zip
        echo   OK: Process Hacker installed
    ) else (
        echo   WARN: Could not download Process Hacker
    )
) else (
    echo   Already installed
)

REM ============================================================
REM 3. API Monitor (manual download required)
REM ============================================================
echo [3/6] API Monitor
echo   API Monitor requires manual download from:
echo   http://www.rohitab.com/apimonitor
echo   (Commercial-friendly freeware)

REM ============================================================
REM 4. PE-bear - PE file analyzer
REM ============================================================
echo [4/6] PE-bear (PE analysis)
if not exist "pe-bear" (
    echo   Downloading PE-bear...
    powershell -Command "Invoke-WebRequest -Uri 'https://github.com/hasherezade/pe-bear/releases/download/v0.6.7.3/PE-bear_0.6.7.3_x64_win.zip' -OutFile 'pebear.zip'"
    if exist "pebear.zip" (
        mkdir pe-bear
        powershell -Command "Expand-Archive -Path 'pebear.zip' -DestinationPath 'pe-bear'"
        del pebear.zip
        echo   OK: PE-bear installed
    ) else (
        echo   WARN: Could not download PE-bear
    )
) else (
    echo   Already installed
)

REM ============================================================
REM 5. Dependency Walker alternative - Dependencies
REM ============================================================
echo [5/6] Dependencies (DLL dependency analyzer)
if not exist "dependencies" (
    echo   Downloading Dependencies...
    powershell -Command "Invoke-WebRequest -Uri 'https://github.com/lucasg/Dependencies/releases/download/v1.11.1/Dependencies_x64_Release.zip' -OutFile 'deps.zip'"
    if exist "deps.zip" (
        mkdir dependencies
        powershell -Command "Expand-Archive -Path 'deps.zip' -DestinationPath 'dependencies'"
        del deps.zip
        echo   OK: Dependencies installed
    ) else (
        echo   WARN: Could not download Dependencies
    )
) else (
    echo   Already installed
)

REM ============================================================
REM 6. Dll Hijack Auditor script
REM ============================================================
echo [6/6] Creating DLL hijack auditor...
if not exist "dll_hijack_check.ps1" (
    (
        echo # DLL Hijack Vulnerability Scanner for WinSplit
        echo # Checks for DLL planting opportunities
        echo.
        echo param^([string]$ExePath^)
        echo.
        echo if ^(-not $ExePath^) {
        echo     Write-Host "Usage: .\dll_hijack_check.ps1 -ExePath 'C:\path\to\WinSplit.exe'"
        echo     exit
        echo }
        echo.
        echo $dir = Split-Path $ExePath
        echo Write-Host "Scanning DLL load paths for: $ExePath"
        echo Write-Host ""
        echo.
        echo # Get imported DLLs using dumpbin or PowerShell
        echo try {
        echo     $pe = [System.Reflection.Assembly]::LoadFile^($ExePath^)
        echo     $imports = $pe.GetReferencedAssemblies^(^)
        echo     foreach ^($imp in $imports^) {
        echo         Write-Host "  $^($imp.Name^).dll"
        echo     }
        echo } catch {
        echo     Write-Host "Using alternative method..."
        echo     $bytes = [System.IO.File]::ReadAllBytes^($ExePath^)
        echo     $str = [System.Text.Encoding]::ASCII.GetString^($bytes^)
        echo     $dlls = [regex]::Matches^($str, '[a-zA-Z0-9_]+\.dll'^) ^| Select-Object -Unique
        echo     foreach ^($dll in $dlls^) {
        echo         Write-Host "  $^($dll.Value^)"
        echo     }
        echo }
        echo.
        echo Write-Host ""
        echo Write-Host "Check these locations for writable directories:"
        echo Write-Host "  1. Application directory: $dir"
        echo Write-Host "  2. Current directory ^(if different^)"
        echo Write-Host "  3. System32: C:\Windows\System32"
        echo Write-Host "  4. Windows: C:\Windows"
        echo Write-Host "  5. PATH directories"
    ) > dll_hijack_check.ps1
    echo   OK: DLL hijack checker created
) else (
    echo   Already exists
)

cd ..

echo.
echo ============================================================
echo  Tool Setup Complete
echo ============================================================
echo.
echo Available tools in pentest\tools\:
echo.
echo   drmemory\         - Memory error detection
echo                       Usage: drmemory\bin\drmemory.exe -light -- WinSplit.exe
echo.
echo   processhacker\    - Process analysis and monitoring
echo                       Usage: processhacker\x64\ProcessHacker.exe
echo.
echo   pe-bear\          - PE file analysis
echo                       Usage: pe-bear\PE-bear.exe WinSplit.exe
echo.
echo   dependencies\     - DLL dependency analysis
echo                       Usage: dependencies\DependenciesGui.exe WinSplit.exe
echo.
echo   dll_hijack_check.ps1 - DLL hijack scanner
echo                       Usage: powershell .\dll_hijack_check.ps1 -ExePath WinSplit.exe
echo.
echo ============================================================
echo.

endlocal
