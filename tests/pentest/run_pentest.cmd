@echo off
REM WinSplit Revolution Comprehensive Security Assessment
REM Runs all penetration testing tools and generates report

setlocal enabledelayedexpansion

echo.
echo ============================================================
echo  WinSplit Revolution Security Assessment
echo  Date: %date% %time%
echo ============================================================
echo.

REM Configuration
set WINSPLIT_PATH=
set WINSPLIT_DLL=
set REPORT_DIR=reports\%date:~-4%-%date:~4,2%-%date:~7,2%_%time:~0,2%-%time:~3,2%

REM Find WinSplit
for %%I in ("..\..\..\upstream\x64\Release\WinSplit.exe") do (
    if exist "%%I" set WINSPLIT_PATH=%%~fI
)

if "%WINSPLIT_PATH%"=="" (
    echo ERROR: WinSplit.exe not found.
    echo Please build WinSplit first or specify the path.
    set /p WINSPLIT_PATH="Enter path to WinSplit.exe: "
)

if not exist "%WINSPLIT_PATH%" (
    echo ERROR: File not found: %WINSPLIT_PATH%
    exit /b 1
)

for %%I in ("%WINSPLIT_PATH%") do set WINSPLIT_DIR=%%~dpI
set WINSPLIT_DLL=%WINSPLIT_DIR%winsplithook.dll

echo Target: %WINSPLIT_PATH%
echo DLL:    %WINSPLIT_DLL%
echo.

REM Create report directory
mkdir "%REPORT_DIR%" 2>nul
echo Reports will be saved to: %REPORT_DIR%
echo.

echo ============================================================
echo  Phase 1: Static Analysis
echo ============================================================
echo.

REM PE Analysis
echo [1.1] PE Structure Analysis
if exist "tools\pe-bear\PE-bear.exe" (
    echo   Running PE-bear analysis...
    echo   (Opens GUI - export report manually)
    start "" "tools\pe-bear\PE-bear.exe" "%WINSPLIT_PATH%"
) else (
    echo   PE-bear not installed. Run setup_pentest_tools.cmd first.
)

REM Dependency Analysis
echo [1.2] DLL Dependency Analysis
if exist "tools\dependencies\DependenciesGui.exe" (
    echo   Analyzing dependencies...
    "tools\dependencies\DependenciesCli.exe" -modules "%WINSPLIT_PATH%" > "%REPORT_DIR%\dependencies.txt" 2>&1
    echo   Saved: dependencies.txt
) else (
    echo   Dependencies not installed.
)

REM DLL Hijack Check
echo [1.3] DLL Hijack Vulnerability Check
if exist "tools\dll_hijack_check.ps1" (
    echo   Checking for DLL hijack vulnerabilities...
    powershell -ExecutionPolicy Bypass -File "tools\dll_hijack_check.ps1" -ExePath "%WINSPLIT_PATH%" > "%REPORT_DIR%\dll_hijack.txt" 2>&1
    echo   Saved: dll_hijack.txt
)

echo.
echo ============================================================
echo  Phase 2: Dynamic Analysis
echo ============================================================
echo.

REM Check if WinSplit is running
tasklist /FI "IMAGENAME eq WinSplit.exe" 2>NUL | find /I /N "WinSplit.exe">NUL
if errorlevel 1 (
    echo WinSplit is not running.
    echo Starting WinSplit for dynamic analysis...

    REM Start under Dr. Memory if available
    if exist "tools\drmemory\bin64\drmemory.exe" (
        echo [2.1] Starting with Dr. Memory instrumentation...
        start "" "tools\drmemory\bin64\drmemory.exe" -light -logdir "%REPORT_DIR%" -- "%WINSPLIT_PATH%"
        timeout /t 5 >nul
    ) else (
        echo [2.1] Starting WinSplit normally...
        start "" "%WINSPLIT_PATH%"
        timeout /t 3 >nul
    )
) else (
    echo WinSplit is already running.
)

REM Run our security tests
echo [2.2] Running security test suite...
if exist "..\bin\test_hook_message_spoofing.exe" (
    ..\bin\test_hook_message_spoofing.exe > "%REPORT_DIR%\test_hook_spoofing.txt" 2>&1
    echo   Saved: test_hook_spoofing.txt
)

if exist "..\bin\test_dll_hijacking.exe" (
    ..\bin\test_dll_hijacking.exe > "%REPORT_DIR%\test_dll_hijacking.txt" 2>&1
    echo   Saved: test_dll_hijacking.txt
)

if exist "..\bin\test_xml_injection.exe" (
    ..\bin\test_xml_injection.exe > "%REPORT_DIR%\test_xml_injection.txt" 2>&1
    echo   Saved: test_xml_injection.txt
)

if exist "..\bin\test_http_updates.exe" (
    ..\bin\test_http_updates.exe > "%REPORT_DIR%\test_http_updates.txt" 2>&1
    echo   Saved: test_http_updates.txt
)

REM Run message spoofer
echo [2.3] Running message spoofing tests...
if exist "..\bin\message_spoofer.exe" (
    ..\bin\message_spoofer.exe --all > "%REPORT_DIR%\message_spoofer.txt" 2>&1
    echo   Saved: message_spoofer.txt
)

echo.
echo ============================================================
echo  Phase 3: Stress Testing
echo ============================================================
echo.

echo [3.1] Running rapid hotkey stress test...
if exist "..\bin\test_rapid_hotkeys.exe" (
    ..\bin\test_rapid_hotkeys.exe > "%REPORT_DIR%\stress_hotkeys.txt" 2>&1
    echo   Saved: stress_hotkeys.txt
)

echo [3.2] Running memory leak detection...
if exist "..\bin\test_memory_leaks.exe" (
    ..\bin\test_memory_leaks.exe > "%REPORT_DIR%\memory_leaks.txt" 2>&1
    echo   Saved: memory_leaks.txt
)

echo.
echo ============================================================
echo  Phase 4: Report Generation
echo ============================================================
echo.

REM Generate summary report
echo Generating summary report...

(
    echo WinSplit Revolution Security Assessment Report
    echo ==============================================
    echo.
    echo Date: %date% %time%
    echo Target: %WINSPLIT_PATH%
    echo.
    echo.
    echo EXECUTIVE SUMMARY
    echo -----------------
    echo.
    echo Critical Vulnerabilities:
    echo   - HTTP Update Mechanism ^(MITM attack vector^)
    echo   - Hook Message Spoofing ^(IPC security^)
    echo.
    echo High Risk:
    echo   - Potential DLL Hijacking
    echo   - PROCESS_ALL_ACCESS usage
    echo.
    echo Medium Risk:
    echo   - XML Configuration injection
    echo   - Integer overflow in settings
    echo.
    echo.
    echo DETAILED FINDINGS
    echo -----------------
    echo.
    if exist "%REPORT_DIR%\test_http_updates.txt" (
        echo === HTTP Update Test ===
        type "%REPORT_DIR%\test_http_updates.txt"
        echo.
    )
    if exist "%REPORT_DIR%\test_hook_spoofing.txt" (
        echo === Hook Spoofing Test ===
        type "%REPORT_DIR%\test_hook_spoofing.txt"
        echo.
    )
    if exist "%REPORT_DIR%\test_dll_hijacking.txt" (
        echo === DLL Hijacking Test ===
        type "%REPORT_DIR%\test_dll_hijacking.txt"
        echo.
    )
    echo.
    echo RECOMMENDATIONS
    echo ---------------
    echo.
    echo 1. CRITICAL: Migrate update mechanism to HTTPS
    echo 2. HIGH: Implement signed updates with verification
    echo 3. HIGH: Load DLLs with full path specification
    echo 4. MEDIUM: Validate all XML input
    echo 5. MEDIUM: Use minimum required process permissions
    echo.
) > "%REPORT_DIR%\SUMMARY.txt"

echo Saved: SUMMARY.txt

echo.
echo ============================================================
echo  Assessment Complete
echo ============================================================
echo.
echo Reports saved to: %REPORT_DIR%
echo.
echo Files generated:
dir /b "%REPORT_DIR%"
echo.
echo Review SUMMARY.txt for the executive report.
echo.

REM Open report folder
explorer "%REPORT_DIR%"

endlocal
